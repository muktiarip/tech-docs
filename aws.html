<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Amazon Web Service | Technical Documentation</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="">
    <link rel="preload" href="/tech-docs/assets/css/0.styles.ab8b8f79.css" as="style"><link rel="preload" href="/tech-docs/assets/js/app.dfb115a1.js" as="script"><link rel="preload" href="/tech-docs/assets/js/2.51172f79.js" as="script"><link rel="preload" href="/tech-docs/assets/js/7.8db61e36.js" as="script"><link rel="prefetch" href="/tech-docs/assets/js/10.0b5c1f39.js"><link rel="prefetch" href="/tech-docs/assets/js/11.1707451e.js"><link rel="prefetch" href="/tech-docs/assets/js/12.d8737bf4.js"><link rel="prefetch" href="/tech-docs/assets/js/13.8f6a049e.js"><link rel="prefetch" href="/tech-docs/assets/js/14.670943a7.js"><link rel="prefetch" href="/tech-docs/assets/js/15.1e01142a.js"><link rel="prefetch" href="/tech-docs/assets/js/16.940ede35.js"><link rel="prefetch" href="/tech-docs/assets/js/17.879aff14.js"><link rel="prefetch" href="/tech-docs/assets/js/18.075d1e0c.js"><link rel="prefetch" href="/tech-docs/assets/js/19.59eb65f3.js"><link rel="prefetch" href="/tech-docs/assets/js/20.2bef0596.js"><link rel="prefetch" href="/tech-docs/assets/js/21.fbaa3c96.js"><link rel="prefetch" href="/tech-docs/assets/js/22.7b3e6b4b.js"><link rel="prefetch" href="/tech-docs/assets/js/23.12a2d88c.js"><link rel="prefetch" href="/tech-docs/assets/js/24.998c7ab9.js"><link rel="prefetch" href="/tech-docs/assets/js/25.005bc2bd.js"><link rel="prefetch" href="/tech-docs/assets/js/26.1049df5b.js"><link rel="prefetch" href="/tech-docs/assets/js/27.326561bf.js"><link rel="prefetch" href="/tech-docs/assets/js/28.ac41bf72.js"><link rel="prefetch" href="/tech-docs/assets/js/29.7825b409.js"><link rel="prefetch" href="/tech-docs/assets/js/3.ab45f5d0.js"><link rel="prefetch" href="/tech-docs/assets/js/30.fafc98be.js"><link rel="prefetch" href="/tech-docs/assets/js/31.26eaac52.js"><link rel="prefetch" href="/tech-docs/assets/js/4.a266f6b6.js"><link rel="prefetch" href="/tech-docs/assets/js/5.6bf111ce.js"><link rel="prefetch" href="/tech-docs/assets/js/6.9130cd55.js"><link rel="prefetch" href="/tech-docs/assets/js/8.c6a0dac0.js"><link rel="prefetch" href="/tech-docs/assets/js/9.8cc6a757.js">
    <link rel="stylesheet" href="/tech-docs/assets/css/0.styles.ab8b8f79.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tech-docs/" class="home-link router-link-active"><!----> <span class="site-name">Technical Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/tech-docs/" aria-current="page" class="sidebar-link">Contents</a></li><li><a href="/tech-docs/android.html" class="sidebar-link">Android</a></li><li><a href="/tech-docs/armbian.html" class="sidebar-link">Armbian</a></li><li><a href="/tech-docs/aws.html" aria-current="page" class="active sidebar-link">Amazon Web Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#aws-cognito" class="sidebar-link">AWS Cognito</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#aws-s3" class="sidebar-link">AWS S3</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#iam-lambda-invoke-for-aliased-function" class="sidebar-link">IAM Lambda Invoke For Aliased Function</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#aws-ec2-ubuntu" class="sidebar-link">AWS EC2 Ubuntu</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#kill-client-connection-in-rds" class="sidebar-link">Kill client connection in RDS</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#aws-lambda-function-post-response-headers" class="sidebar-link">AWS Lambda Function POST Response Headers</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#aws-lambda-function-options-response-headers" class="sidebar-link">AWS Lambda Function OPTIONS Response Headers</a></li><li class="sidebar-sub-header"><a href="/tech-docs/aws.html#references-2" class="sidebar-link">References</a></li></ul></li><li><a href="/tech-docs/bluetooth.html" class="sidebar-link">Bluetooth</a></li><li><a href="/tech-docs/cryptography.html" class="sidebar-link">Cryptography</a></li><li><a href="/tech-docs/database.html" class="sidebar-link">Databases</a></li><li><a href="/tech-docs/docker.html" class="sidebar-link">Docker</a></li><li><a href="/tech-docs/electronics.html" class="sidebar-link">Electronics Notes</a></li><li><a href="/tech-docs/git.html" class="sidebar-link">Git Notes</a></li><li><a href="/tech-docs/hardware.html" class="sidebar-link">Hardware</a></li><li><a href="/tech-docs/javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/tech-docs/linux.html" class="sidebar-link">Linux Notes</a></li><li><a href="/tech-docs/ml.html" class="sidebar-link">Machine Learning</a></li><li><a href="/tech-docs/nginx.html" class="sidebar-link">NginX</a></li><li><a href="/tech-docs/programming.html" class="sidebar-link">Programming</a></li><li><a href="/tech-docs/python.html" class="sidebar-link">Python Programming</a></li><li><a href="/tech-docs/rpi.html" class="sidebar-link">Raspberry Pi</a></li><li><a href="/tech-docs/rust.html" class="sidebar-link">Rust Programming Language</a></li><li><a href="/tech-docs/stm32/" class="sidebar-link">STM32</a></li><li><a href="/tech-docs/links.html" class="sidebar-link">Various Links</a></li><li><a href="/tech-docs/vim.html" class="sidebar-link">VIM</a></li><li><a href="/tech-docs/webapp.html" class="sidebar-link">Web Application</a></li><li><a href="/tech-docs/yocto-project.html" class="sidebar-link">Yocto Project</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="amazon-web-service"><a href="#amazon-web-service" class="header-anchor">#</a> Amazon Web Service</h1> <h2 id="aws-cognito"><a href="#aws-cognito" class="header-anchor">#</a> AWS Cognito</h2> <h3 id="how-to-find-bidirectional-map-between-cognito-identity-id-and-cognito-user-information"><a href="#how-to-find-bidirectional-map-between-cognito-identity-id-and-cognito-user-information" class="header-anchor">#</a> How to find bidirectional map between Cognito identity ID and Cognito user information?</h3> <blockquote><p>Cited from this <a href="https://github.com/aws-amplify/amplify-js/issues/54" target="_blank" rel="noopener noreferrer">discussion<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>What we are doing to solve this problem, which has worked ok so far, is we set
the user pool Username to match the IdentityId from the identity pool when
creating a new user. Since they match, the bidirectional mapping between the
two services is now pretty trivial 😉</p> <p>The new user signup flow goes like this:</p> <ul><li>pull an unauthenticated IdentityId from the identity pool using <code>getId()</code></li> <li>call <code>signUp()</code> on the user pool, passing in the IdentityId from the previous
call as the new user's Username (we put their human-readable username in
preferred_username)</li> <li>then after user has confirmed their email/phone and signed in to the user
pool, we link the user pool entry back to the identity pool entry by calling
<code>getCredentialsForIdentity()</code> using same IdentityId/Username from before along
with the <code>IdToken</code> from the user pool</li></ul> <p>We implemented this first with the lower-level SDK's linked to above. I didn't
handle the mapping of this up to amplify but I understand that was a
non-trivial task.</p> <p>And obviously this won't work so well if you already have a bunch of users, but
if you're building a new app like we are, hopefully this works for you too.</p> <h3 id="mapping-cognito-user-pool-id-to-cognito-identity-pool-id-alternative-solution"><a href="#mapping-cognito-user-pool-id-to-cognito-identity-pool-id-alternative-solution" class="header-anchor">#</a> Mapping Cognito User Pool Id to Cognito Identity Pool Id (Alternative Solution)</h3> <p>We don't comment on the status or priority of feature requests. I'll suggest
one more approach which should address the security concerns expressed above.</p> <ol><li>Add a custom attribute to your user pools schema called identityId</li> <li>Make it read-only to the client that your end users are authenticating with</li> <li>Authenticate the end user</li> <li>Get AWS credentials for the end user</li> <li>If there is no identity id present in the user profile, call a Lambda using
the AWS credentials from step 4 and provide the id token from the end user as
a parameter.</li> <li>In the lambda call Cognito Federated Identity's GetId and pass the id token
for the end user in the logins map, this will return the identity id</li> <li>In the lambda call AdminUpdateUser to set the IdentityId profile attribute
to the value returned in step 6</li> <li>Optionally refresh the end users' user pool tokens so they will have the
identity id in them</li></ol> <p>Since the attribute cannot be set by the end user and there are no assumptions
about what the end user provides the Lambda this should be secure.</p> <p>See <a href="https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API_GetId.html" target="_blank" rel="noopener noreferrer">GetId API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
Supplied idToken (containing <code>user pool sub</code> attribute) will be correlated with <code>identity pool identityId</code>).</p> <p><strong>In lambda function:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>identityId = GetId({&quot;CognitoUserPoolARN&quot;: &quot;IdTokenString&quot;})
sub = ExtractSubFrom(&quot;IdTokenString&quot;);
AdminUpdateUser(sub, &quot;attr:identityId&quot;, identityId)
</code></pre></div><h3 id="aws-stack-authentication-dance"><a href="#aws-stack-authentication-dance" class="header-anchor">#</a> AWS Stack Authentication Dance</h3> <ol><li><p>OPTIONS to <code>https://cognito-idp.ap-southeast-1.amazonaws.com/</code>
Request headers:</p> <ul><li><code>access-control-request-headers: content-type,x-amz-target,x-amz-user-agent</code></li> <li><code>access-control-request-method: POST</code></li></ul> <p>Get response headers as follows:</p> <ul><li><code>access-control-allow-headers: content-type,x-amz-target,x-amz-user-agent</code></li> <li><code>access-control-allow-methods: POST</code></li> <li><code>access-control-allow-origin: *</code></li> <li><code>access-control-expose-headers: x-amzn-RequestId,x-amzn-ErrorType,x-amzn-ErrorMessage,Date</code></li> <li><code>access-control-max-age: 172800</code></li></ul></li> <li><p>POST to <code>https://cognito-idp.ap-southeast-1.amazonaws.com/</code> (SRP A)
Request payload:</p> <ul><li>AuthFlow: &quot;USER_SRP_AUTH&quot;
Response headers:</li> <li><code>access-control-allow-origin: *</code></li> <li><code>access-control-expose-headers: x-amzn-RequestId,x-amzn-ErrorType,x-amzn-ErrorMessage,Date</code>
Response payload:</li> <li>ChallengeName: &quot;PASSWORD_VERIFIER&quot;</li></ul></li> <li><p>POST to <code>https://cognito-idp.ap-southeast-1.amazonaws.com/</code> (SRP B)
Request headers:</p> <ul><li><code>x-amz-target: AWSCognitoIdentityProviderService.RespondToAuthChallenge</code></li> <li><code>x-amz-user-agent: aws-amplify/0.1.x js</code>
Request payload:</li> <li>ChallengeName: &quot;PASSWORD_VERIFIER&quot;
Response headers:</li> <li><code>access-control-allow-origin: *</code></li> <li><code>access-control-expose-headers: x-amzn-RequestId,x-amzn-ErrorType,x-amzn-ErrorMessage,Date</code>
Response payload:</li> <li>AuthenticationResult: { ... }</li></ul></li> <li><p>OPTIONS to <code>https://lupfb8uakg.execute-api.ap-southeast-1.amazonaws.com/prod</code>
(API gateway for custom STS assume role service)
Request headers:</p> <ul><li><code>access-control-request-headers: content-type</code></li> <li><code>access-control-request-method: POST</code>
Response headers:</li> <li><code>access-control-allow-headers: Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token</code></li> <li><code>access-control-allow-methods: OPTIONS,POST</code></li> <li><code>access-control-allow-origin: *</code></li></ul></li> <li><p>POST to <code>https://lupfb8uakg.execute-api.ap-southeast-1.amazonaws.com/prod</code>
(API gateway for custom STS assume role service)
Request payload:</p> <ul><li>realm: &quot;user&quot;</li> <li>token: &quot; ... &quot;
Response:</li> <li>Custom data including temporary IAM credentials.</li></ul></li></ol> <p>Note:</p> <ul><li>1, 2, 3 is part of Cognito Authentication</li> <li>4, 5 call API gateway endpoint for custom STS assume role service to
get temporary IAM credentials.</li></ul> <h3 id="aws-cognito-flow"><a href="#aws-cognito-flow" class="header-anchor">#</a> AWS Cognito Flow</h3> <p><code>Cognito User Pool -&gt; idToken -&gt; Cognito Identity Pool -&gt; IAM creds</code></p> <h3 id="aws-cognito-cli"><a href="#aws-cognito-cli" class="header-anchor">#</a> AWS Cognito CLI</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>aws cognito-idp admin-update-user-attributes <span class="token punctuation">\</span>
    --user-pool-id  ap-southeast-1_********* <span class="token punctuation">\</span>
    --username username@example.com <span class="token punctuation">\</span>
    --user-attributes <span class="token assign-left variable">Name</span><span class="token operator">=</span>custom:become,Value<span class="token operator">=</span>newrole
</code></pre></div><h2 id="aws-s3"><a href="#aws-s3" class="header-anchor">#</a> AWS S3</h2> <h3 id="iam-policy-template-for-s3-bucket"><a href="#iam-policy-template-for-s3-bucket" class="header-anchor">#</a> IAM Policy Template For S3 Bucket</h3> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AddPerm&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s3:GetObject&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:s3:::&lt;bucket-name&gt;/*&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="s3-cors-configuration"><a href="#s3-cors-configuration" class="header-anchor">#</a> S3 CORS Configuration</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CORSConfiguration</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://s3.amazonaws.com/doc/2006-03-01/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CORSRule</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AllowedOrigin</span><span class="token punctuation">&gt;</span></span>*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AllowedOrigin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AllowedMethod</span><span class="token punctuation">&gt;</span></span>GET<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AllowedMethod</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AllowedMethod</span><span class="token punctuation">&gt;</span></span>POST<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AllowedMethod</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AllowedMethod</span><span class="token punctuation">&gt;</span></span>PUT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AllowedMethod</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxAgeSeconds</span><span class="token punctuation">&gt;</span></span>3000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxAgeSeconds</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AllowedHeader</span><span class="token punctuation">&gt;</span></span>*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AllowedHeader</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CORSRule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CORSConfiguration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="caching-pre-signed-s3-objects"><a href="#caching-pre-signed-s3-objects" class="header-anchor">#</a> Caching Pre-signed S3 Objects</h3> <div class="language-python extra-class"><pre class="language-python"><code>INTERVAL <span class="token operator">=</span> <span class="token number">600</span>
GRACE <span class="token operator">=</span> <span class="token number">60</span>
now <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
t <span class="token operator">=</span> now <span class="token operator">-</span> <span class="token punctuation">(</span>now <span class="token operator">%</span> INTERVAL<span class="token punctuation">)</span>
expire <span class="token operator">=</span> t <span class="token operator">+</span> INTERVAL <span class="token operator">+</span> GRACE
URL <span class="token operator">=</span> buildSIgnature<span class="token punctuation">(</span>Expire<span class="token operator">=</span>expire<span class="token punctuation">)</span>
</code></pre></div><h3 id="references"><a href="#references" class="header-anchor">#</a> References</h3> <ul><li><a href="https://github.com/department-stockholm/aws-signature-v4" target="_blank" rel="noopener noreferrer">Library<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.aws.amazon.com/general/latest/gr/sigv4-signed-request-examples.html" target="_blank" rel="noopener noreferrer">Examples of the Complete Version 4 Signing Process (Python)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="s3-presign-url-with-python"><a href="#s3-presign-url-with-python" class="header-anchor">#</a> S3 Presign URL With Python</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> base64
<span class="token keyword">import</span> hmac
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> os
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse

<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

AWS_ACCESS_KEY_ID <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'AWS_ACCESS_KEY_ID'</span><span class="token punctuation">)</span>
AWS_SECRET_ACCESS_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'AWS_SECRET_ACCESS_KEY'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">s3PresignUrl</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> baseTime<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> expires<span class="token operator">=</span><span class="token number">900</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> baseTime <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        timeout <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        timeout <span class="token operator">=</span> baseTime <span class="token operator">+</span> expires
    
    payload <span class="token operator">=</span> <span class="token string">&quot;GET\n\n\n{}\n/{}/{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    h <span class="token operator">=</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>AWS_SECRET_ACCESS_KEY<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">)</span>
    signature <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote_plus<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>encodestring<span class="token punctuation">(</span>h<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;.s3.amazonaws.com/&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> \
        <span class="token string">&quot;?AWSAccessKeyId=&quot;</span> <span class="token operator">+</span> AWS_ACCESS_KEY_ID <span class="token operator">+</span> \
        <span class="token string">&quot;&amp;Expires={}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&amp;Signature=&quot;</span> <span class="token operator">+</span> signature
    <span class="token keyword">return</span> url
</code></pre></div><h3 id="get-only-first-1000-byte-of-an-object"><a href="#get-only-first-1000-byte-of-an-object" class="header-anchor">#</a> Get only first 1000 byte of an object</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>aws s3api get-object --bucket hh-system-storage <span class="token punctuation">\</span>
  --key transient/aws/CdxdjDpF8Eo.mp4 --range <span class="token string">&quot;bytes=0-999&quot;</span> CdxdjDpF8Eo.mp4-01
</code></pre></div><h3 id="s3-metadata-to-prevent-cache"><a href="#s3-metadata-to-prevent-cache" class="header-anchor">#</a> S3 Metadata to prevent cache</h3> <div class="language- extra-class"><pre class="language-text"><code>Cache-Control: no-cache, no-store, must-revalidate
aws --endpoint-url http://192.168.0.103:9000 --profile your_profile s3 ls s3://bucket_name/
</code></pre></div><h2 id="iam-lambda-invoke-for-aliased-function"><a href="#iam-lambda-invoke-for-aliased-function" class="header-anchor">#</a> IAM Lambda Invoke For Aliased Function</h2> <p><code>&quot;arn:aws:lambda:::function:name:alias&quot;</code> won't work</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;arn:aws:lambda:::function:name&quot;
&quot;arn:aws:lambda:::function:name:alias&quot;
</code></pre></div><p>works</p> <h2 id="aws-ec2-ubuntu"><a href="#aws-ec2-ubuntu" class="header-anchor">#</a> AWS EC2 Ubuntu</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> locale-gen <span class="token string">&quot;en_US.UTF-8&quot;</span>
<span class="token function">sudo</span> dpkg-reconfigure locales
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> upgrade
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y lighttpd python3-venv python3-dev libmysqlclient-dev gcc letsencrypt
<span class="token function">sudo</span> <span class="token function">cp</span> -a /etc/lighttpd/lighttpd.conf /etc/lighttpd/lighttpd.conf.orig
python3 -m venv ./venv
<span class="token builtin class-name">.</span> venv/bin/activate
pip <span class="token function">install</span> --upgrade pip setuptools
pip <span class="token function">install</span> flipflop flask-sqlalchemy flask-admin flask-security-fork flask-restful boto3 awscli mysqlclient
</code></pre></div><h2 id="kill-client-connection-in-rds"><a href="#kill-client-connection-in-rds" class="header-anchor">#</a> Kill client connection in RDS</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> processlist<span class="token punctuation">;</span>
<span class="token keyword">call</span> mysql<span class="token punctuation">.</span>rds_kill<span class="token punctuation">(</span>PID<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="aws-lambda-function-post-response-headers"><a href="#aws-lambda-function-post-response-headers" class="header-anchor">#</a> AWS Lambda Function POST Response Headers</h2> <div class="language- extra-class"><pre class="language-text"><code>access-control-allow-origin: *
access-control-expose-headers: x-amzn-RequestId,x-amzn-ErrorType,x-amzn-ErrorMessage,Date,x-amz-log-result,x-amz-function-error
content-type: application/json
status: 200
x-amz-executed-version: 6
x-amzn-remapped-content-length: 0
</code></pre></div><h2 id="aws-lambda-function-options-response-headers"><a href="#aws-lambda-function-options-response-headers" class="header-anchor">#</a> AWS Lambda Function OPTIONS Response Headers</h2> <div class="language- extra-class"><pre class="language-text"><code>access-control-allow-headers: authorization,content-type,x-amz-content-sha256,x-amz-date,x-amz-invocation-type,x-amz-security-token,x-amz-user-agent
access-control-allow-methods: POST
access-control-allow-origin: *
access-control-expose-headers: x-amzn-RequestId,x-amzn-ErrorType,x-amzn-ErrorMessage,Date,x-amz-log-result,x-amz-function-error
access-control-max-age: 172800
</code></pre></div><h2 id="references-2"><a href="#references-2" class="header-anchor">#</a> References</h2> <ul><li>https://aws.amazon.com/blogs/compute/microservices-without-the-servers/</li> <li>https://aws.amazon.com/blogs/compute/cloudmicro-for-aws-speeding-up-serverless-development-at-the-coca-cola-company/</li> <li><a href="https://www.linkedin.com/pulse/aws-cloud-virtual-smart-doctor-wong-chun-yin-cyrus-%E9%BB%83%E4%BF%8A%E5%BD%A5-" target="_blank" rel="noopener noreferrer">Virtual Doctor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>https://youtu.be/cU8HldjM1DI</li> <li>https://github.com/awslabs/dynamodb-transactions</li> <li>http://docs.aws.amazon.com/lambda/latest/dg/deployment-package-v2.h* <a href="https://aws.amazon.com/blogs/apn/managing-saas-identity-through-custom-attributes-and-amazon-cognito/" target="_blank" rel="noopener noreferrer">Managing SaaS Identity Through Custom Attributes and Amazon Cognito<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
tml?shortFooter=true</li> <li>https://aws.amazon.com/blogs/big-data/from-sql-to-microservices-integrating-aws-lambda-with-relational-databases/</li> <li>http://docs.aws.amazon.com/lambda/latest/dg/versioning-aliases-permissions.html?shortFooter=true</li> <li>https://github.com/sportarchive/aws-lambda-python-local</li> <li>https://github.com/danilop/LambdAuth</li> <li>https://www.sitepoint.com/sql-vs-nosql-differences/</li> <li>http://docs.aws.amazon.com/lambda/latest/dg/with-s3.html?shortFooter=true</li> <li>User management using Cognito and Lambda
<ul><li>https://aws.amazon.com/blogs/mobile/amazon-cognito-announcing-developer-authenticated-identities/</li> <li>http://docs.aws.amazon.com/cognito/latest/developerguide/developer-authenticated-identities.html</li> <li>https://aws.amazon.com/blogs/mobile/understanding-amazon-cognito-authentication-part-2-developer-authenticated-identities/</li> <li>http://docs.aws.amazon.com/cognito/latest/developerguide/authentication-flow.html</li> <li>http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools-working-with-aws-lambda-triggers.html</li> <li>https://auth0.com/blog/building-serverless-apps-with-aws-lambda/</li> <li>https://www.gellock.com/2015/11/25/building-a-user-management-microservice-using-aws-part-1/</li> <li>https://blog.fugue.co/2016-05-05-architecting-a-serverless-web-application-in-aws.html</li> <li>http://blog.tonyfendall.com/2015/12/serverless-architectures-using-aws-lambda/</li> <li>https://github.com/danilop/LambdAuth</li></ul></li> <li><a href="https://aws.amazon.com/blogs/developer/category/python/" target="_blank" rel="noopener noreferrer">Chalice local development<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Uploading file to S3 directly from users browser
<ul><li>http://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-UsingHTTPPOST.html</li> <li>http://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-authentication-HTTPPOST.html</li> <li>https://github.com/joeyespo/flask-s3-example</li> <li>https://devcenter.heroku.com/articles/s3-upload-python</li></ul></li> <li><a href="https://trailhead.salesforce.com/en/content/learn/trails/learn-the-aws-cloud-practitioner-essentials#" target="_blank" rel="noopener noreferrer">Learn the AWS Cloud Practitioner Essentials<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.trek10.com/blog/the-ten-rules-for-data-modeling-with-dynamodb" target="_blank" rel="noopener noreferrer">The Ten Rules for Data Modeling with DynamoDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.integralist.co.uk/posts/cognito/#implementation-options" target="_blank" rel="noopener noreferrer">Authentication with AWS Cognito<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>AWS Local version
<ul><li><a href="https://github.com/p4tin/goaws" target="_blank" rel="noopener noreferrer">GoAws: AWS (SQS/SNS) Clone for Development testing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/localstack/localstack" target="_blank" rel="noopener noreferrer">Localstack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li><a href="https://github.com/awslabs/dynamodb-transactions/blob/master/DESIGN.md" target="_blank" rel="noopener noreferrer">DynamoDB ACID transaction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.trek10.com/blog/dynamodb-single-table-relational-modeling/" target="_blank" rel="noopener noreferrer">From relational DB to single DynamoDB table<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/trek10inc/ddb-single-table-example" target="_blank" rel="noopener noreferrer">DynamoDB Single Table Example<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.dynamodbguide.com/" target="_blank" rel="noopener noreferrer">DynamoDB Explained<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/devopslinks/this-is-how-i-reduced-my-cloudfront-bills-by-80-a7b0dfb24128" target="_blank" rel="noopener noreferrer">This is How I Reduced My CloudFront Bills by 80%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://aws.amazon.com/blogs/compute/scheduling-ssh-jobs-using-aws-lambda/" target="_blank" rel="noopener noreferrer">Scheduling SSH jobs using AWS Lambda<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tech-docs/armbian.html" class="prev">
        Armbian
      </a></span> <span class="next"><a href="/tech-docs/bluetooth.html">
        Bluetooth
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/tech-docs/assets/js/app.dfb115a1.js" defer></script><script src="/tech-docs/assets/js/2.51172f79.js" defer></script><script src="/tech-docs/assets/js/7.8db61e36.js" defer></script>
  </body>
</html>
